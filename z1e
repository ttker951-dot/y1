-- 防通知篡改钩子
local old
old = hookmetamethod(game:GetService("StarterGui"), "__namecall", newcclosure(function(self, ...)
    local method = getnamecallmethod()
    local args = {...}
    if method == "SetCore" and args[1] == "SendNotification" then
        local options = args[2]
        if type(options) == "table" and 
           tostring(options.Title) == "人挤人" and 
           tostring(options.Text) == "人挤人" 
        then
            local modifiedOptions = table.clone(options)
            modifiedOptions.Text = "1"
            return old(self, "SetCore", "SendNotification", modifiedOptions)
        end
    end
    return old(self, ...)
end))

-- 加载提示
game:GetService("StarterGui"):SetCore("SendNotification",{
    Title = "人挤人",
    Text = "Loading...",
    Duration = 5;
})
task.wait(0.1)

-- 服务初始化
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- 加载UI库
local ui = loadstring(game:HttpGet("https://raw.githubusercontent.com/ttker951-dot/y1/refs/heads/main/u1.lua"))()
local win = ui:new("人挤人")

-- 创建标签页
local UITab1 = win:Tab("Announcements",'7734068321')
local UITab2 = win:Tab("Features",'7734068321')
local UITab3 = win:Tab("Buddha",'7734068321')
local UITab4 = win:Tab("ESP",'7734068321')
local UITab5 = win:Tab("Teleport",'7734068321')
local UITab6 = win:Tab("Features 2",'7734068321')

-- ===================== 公告标签页 =====================
local noticeSection = UITab1:section("Announcements", true)
noticeSection:Label("by kismile")
noticeSection:Label("Script in Testing")

-- ===================== 通用标签页 =====================
local generalSection = UITab2:section("General", true)

-- 视角缩放
generalSection:Slider("Camera Zoom Distance", "CameraZoom", 128, 128, 10000, false, function(Value)
    LocalPlayer.CameraMaxZoomDistance = Value
end)

-- 移速功能
getfenv().translateSpeed = 50  -- 默认速度
getfenv().translateConnection = nil

generalSection:Textbox("Speed", "TranslateSpeed", "50", function(Value)
    local speed = tonumber(Value)
    if speed then
        getfenv().translateSpeed = speed
    end
end)

generalSection:Toggle("Speed Boost Toggle", "TranslateToggle", false, function(State)
    getfenv().translateAccelEnabled = State
    
    -- 断开原有连接
    if getfenv().translateConnection then
        getfenv().translateConnection:Disconnect()
        getfenv().translateConnection = nil
    end
    
    if State then
        -- 创建新连接
        getfenv().translateConnection = RunService.Heartbeat:Connect(function()
            local char = LocalPlayer.Character
            if not char then return end
            
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if not humanoid or humanoid.Health <= 0 then return end
            
            if humanoid.MoveDirection.Magnitude > 0 then
                local moveDirection = humanoid.MoveDirection
                local acceleration = moveDirection * (getfenv().translateSpeed or 50) / 30
                char:TranslateBy(acceleration)
            end
        end)
    end
end)

-- 快捷功能按钮
generalSection:Button("Fly", function()
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/ttker951-dot/y1/refs/heads/main/rf"))()
    end)
end)

generalSection:Button("Reduce Graphics", function()
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/ttker951-dot/y1/refs/heads/main/rfb"))()
    end)
end)

generalSection:Button("Remove Lava", function()
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/ttker951-dot/y1/refs/heads/main/lava"))()
    end)
end)

generalSection:Button("Remove Fog", function()
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/ttker951-dot/y1/refs/heads/main/fog"))()
    end)
end)


-- ===================== 范围攻击标签页 =====================
local attackSection = UITab3:section("AoE Attack", true)

-- 快速攻击核心配置
local _ENV = (getgenv or getrenv or getfenv)()
local Settings = {AutoClick = true, ClickDelay = 0.3}
local _G = _G or getfenv(0)._G
_G.FastAttack = _G.FastAttack ~= nil and _G.FastAttack or true
-- Auto Haki配置
local AutoHakiEnabled = false
local autoHakiTask = nil

-- Auto Haki循环函数
local function startAutoHakiLoop()
    if autoHakiTask then
        task.cancel(autoHakiTask)
        autoHakiTask = nil
    end
    
    autoHakiTask = task.spawn(function()
        while AutoHakiEnabled do
            task.wait(0.2)
            if AutoHakiEnabled and LocalPlayer.Character and not LocalPlayer.Character:FindFirstChild("HasBuso") then
                pcall(function()
                    ReplicatedStorage.Remotes.CommF_:InvokeServer("Buso")
                end)
            end
        end
        autoHakiTask = nil
    end)
end

-- 角色重生时重启Auto Haki
LocalPlayer.CharacterAdded:Connect(function(newCharacter)
    if AutoHakiEnabled then
        task.wait(2) -- 等待角色完全加载
        startAutoHakiLoop()
    end
end)

-- 工具函数
local function SafeWaitForChild(parent, childName, timeout)
    timeout = timeout or 10
    local success, result = pcall(function() 
        return parent:WaitForChild(childName, timeout) 
    end)
    if not success or not result then 
        warn("Component not found: " .. childName) 
    end
    return result
end

local function CheckAndGetCoreComponents()
    local Remotes, Modules, Net, RegisterAttack, RegisterHit, Enemies = nil, nil, nil, nil, nil, nil
    
    Remotes = SafeWaitForChild(ReplicatedStorage, "Remotes")
    Modules = SafeWaitForChild(ReplicatedStorage, "Modules")
    Net = Modules and SafeWaitForChild(Modules, "Net") or nil
    RegisterAttack = Net and SafeWaitForChild(Net, "RE/RegisterAttack") or nil
    RegisterHit = Net and SafeWaitForChild(Net, "RE/RegisterHit") or nil
    Enemies = SafeWaitForChild(Workspace, "Enemies")
    
    if Remotes and Modules and Net and RegisterAttack and RegisterHit and Enemies then
        return Remotes, Net, RegisterAttack, RegisterHit, Enemies
    end
    return nil
end

local function IsAlive(character)
    if not character then return false end
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    return humanoid and humanoid.Health and humanoid.Health > 0
end

local function GetRandomValidPart(target)
    local allParts = target:GetDescendants()
    local validParts = {}
    local humanoidRootPart = target:FindFirstChild("HumanoidRootPart")
    local boneParts = humanoidRootPart and humanoidRootPart.Parent:GetDescendants() or {}
    
    for _, part in ipairs(allParts) do
        if part:IsA("BasePart") and part.CanCollide and table.find(boneParts, part) then
            table.insert(validParts, part)
        end
    end
    
    return #validParts > 0 and validParts[math.random(1, #validParts)] or target:FindFirstChild("HumanoidRootPart")
end

-- 快速攻击模块
local FastAttackModule = (function()
    if _ENV.rz_FastAttack then return _ENV.rz_FastAttack end
    
    local FastAttack = {
        Distance = 2500,
        attackMobs = true,
        attackPlayers = true,
        Equipped = nil,
        IsRunning = _G.FastAttack,
        consecutiveFailures = 0,
        maxConsecutiveFailures = 5
    }

    local function ProcessEnemies(OthersEnemies, Folder)
        if not Folder or not FastAttack.attackMobs then return nil end
        local BasePart = nil
        
        for _, Enemy in Folder:GetChildren() do
            if Enemy == LocalPlayer.Character or not IsAlive(Enemy) then continue end
            local foundPart = GetRandomValidPart(Enemy)
            
            if foundPart and LocalPlayer:DistanceFromCharacter(foundPart.Position) < FastAttack.Distance then
                table.insert(OthersEnemies, {Enemy, foundPart})
                BasePart = foundPart
            end
        end
        return BasePart
    end

    local function ProcessRealPlayers(OthersEnemies)
        if not FastAttack.attackPlayers then return nil end
        local BasePart = nil
        
        for _, OtherPlayer in Players:GetPlayers() do
            if OtherPlayer == LocalPlayer then continue end
            local OtherChar = OtherPlayer.Character
            
            if not IsAlive(OtherChar) then continue end
            local foundPart = GetRandomValidPart(OtherChar)
            
            if foundPart and LocalPlayer:DistanceFromCharacter(foundPart.Position) < FastAttack.Distance then
                table.insert(OthersEnemies, {OtherChar, foundPart})
                BasePart = foundPart
            end
        end
        return BasePart
    end

    function FastAttack:Attack(BasePart, OthersEnemies)
        local components = {CheckAndGetCoreComponents()}
        local Net, temp_RegisterAttack, temp_RegisterHit = components[2], components[3], components[4]
        
        if not (BasePart and OthersEnemies and #OthersEnemies > 0 and temp_RegisterAttack and temp_RegisterHit) then
            self.consecutiveFailures = self.consecutiveFailures + 1
            
            if self.consecutiveFailures >= self.maxConsecutiveFailures then
                self.consecutiveFailures = 0
                self.Equipped = LocalPlayer.Character and IsAlive(LocalPlayer.Character) and LocalPlayer.Character:FindFirstChildOfClass("Tool")
            end
            
            task.delay(0.5, function() self:AttackNearest() end)
            return
        end
        
        self.consecutiveFailures = 0
        temp_RegisterAttack:FireServer(Settings.ClickDelay or 0)
        temp_RegisterHit:FireServer(BasePart, OthersEnemies)
    end

    function FastAttack:AttackNearest()
        if not self.IsRunning then return end
        local components = {CheckAndGetCoreComponents()}
        local Enemies = components[5]
        local OthersEnemies = {}
        
        local Part1 = ProcessEnemies(OthersEnemies, Enemies)
        local Part2 = ProcessRealPlayers(OthersEnemies)
        
        if #OthersEnemies > 0 then
            self:Attack(Part1 or Part2, OthersEnemies)
        end
    end

    function FastAttack:BladeHits()
        if not self.IsRunning then return end
        local Equipped = LocalPlayer.Character and IsAlive(LocalPlayer.Character) and LocalPlayer.Character:FindFirstChildOfClass("Tool")
        
        if Equipped and Equipped.ToolTip ~= "Gun" then
            self:AttackNearest()
        end
    end

    -- 攻击循环
    task.spawn(function()
        while true do
            task.wait(Settings.ClickDelay)
            if Settings.AutoClick and FastAttack.IsRunning then
                FastAttack:BladeHits()
            else
                task.wait(0.1)
            end
        end
    end)

    _ENV.rz_FastAttack = FastAttack
    return FastAttack
end)()

-- 范围攻击UI绑定
attackSection:Toggle("Attack Toggle", "FastAttackToggle", _G.FastAttack, function(state)
    if _ENV.rz_FastAttack then
        _ENV.rz_FastAttack.IsRunning = state
        _G.FastAttack = state
    end
end)

attackSection:Textbox("Attack Range", "AttackRange", "2500", function(text)
    local num = tonumber(text) or 2500
    num = math.floor(math.clamp(num, 1, 2500))
    if _ENV.rz_FastAttack then
        _ENV.rz_FastAttack.Distance = num
    end
end)

attackSection:Textbox("Attack Speed", "ClickDelay", "0.3", function(text)
    local num = tonumber(text) or 0.3
    num = math.round(math.clamp(num, 0.05, 2) * 100) / 100
    Settings.ClickDelay = num
end)

attackSection:Toggle("Attack Mobs", "AttackMobsToggle", true, function(state)
    if _ENV.rz_FastAttack then
        _ENV.rz_FastAttack.attackMobs = state
    end
end)

attackSection:Toggle("Attack Players", "AttackPlayersToggle", true, function(state)
    if _ENV.rz_FastAttack then
        _ENV.rz_FastAttack.attackPlayers = state
    end
end)

-- 自动V4功能
local toggleKey = "Auto V4"
local autoV4Task = nil

-- 初始化全局开关状态
if not _G.ToggleStates then
    _G.ToggleStates = {}
end

local function getToggleState(key)
    return _G.ToggleStates[key] or false
end

local function callAwakeningRemote()
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid or humanoid.Health <= 0 then return end

    local Backpack = LocalPlayer:FindFirstChild("Backpack")
    if not Backpack then return end
    
    local Awakening = Backpack:FindFirstChild("Awakening")
    if not Awakening then return end
    
    local RemoteFunc = Awakening:FindFirstChild("RemoteFunction")
    if not RemoteFunc or not RemoteFunc:IsA("RemoteFunction") then return end
    
    local success, err = pcall(function()
        RemoteFunc:InvokeServer(true)
    end)
    if not success then
        warn("Auto V4 call failed: ", err)
    end
end

local function runAutoV4Loop()
    if autoV4Task then
        task.cancel(autoV4Task)
        autoV4Task = nil
    end

    autoV4Task = task.spawn(function()
        while getToggleState(toggleKey) do
            callAwakeningRemote()
            task.wait(1)
        end
        autoV4Task = nil
    end)
end

local function toggleAutoV4(enable)
    if autoV4Task then
        task.cancel(autoV4Task)
        autoV4Task = nil
    end

    if enable then
        runAutoV4Loop()
    end
end

-- 角色重生时重启自动V4
LocalPlayer.CharacterAdded:Connect(function(newCharacter)
    newCharacter:WaitForChild("Humanoid")
    if getToggleState(toggleKey) then
        toggleAutoV4(true)
    end
end)

-- 自动V4 UI绑定
attackSection:Toggle(toggleKey, "AutoV4Toggle", false, function(IsEnabled)
    _G.ToggleStates[toggleKey] = IsEnabled
    toggleAutoV4(IsEnabled)
end)

-- 自动V3功能
local toggleKeyV3 = "Auto V3"
local autoV3Task = nil

local function callRaceV3Remote()
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid or humanoid.Health <= 0 then return end

    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local Remotes = ReplicatedStorage:FindFirstChild("Remotes")
    if not Remotes then return end
    
    local CommE = Remotes:FindFirstChild("CommE")
    if not CommE or not CommE:IsA("RemoteEvent") then return end
    
    local success, err = pcall(function()
        CommE:FireServer("ActivateAbility")
    end)
    if not success then
        warn("Auto V3 call failed: ", err)
    end
end

local function runAutoV3Loop()
    if autoV3Task then
        task.cancel(autoV3Task)
        autoV3Task = nil
    end

    autoV3Task = task.spawn(function()
        while getToggleState(toggleKeyV3) do
            callRaceV3Remote()
            task.wait(1)
        end
        autoV3Task = nil
    end)
end

local function toggleAutoV3(enable)
    if autoV3Task then
        task.cancel(autoV3Task)
        autoV3Task = nil
    end

    if enable then
        runAutoV3Loop()
    end
end

-- 角色重生时重启自动V3
LocalPlayer.CharacterAdded:Connect(function(newCharacter)
    newCharacter:WaitForChild("Humanoid")
    if getToggleState(toggleKeyV3) then
        toggleAutoV3(true)
    end
end)

-- 自动V3 UI绑定
attackSection:Toggle(toggleKeyV3, "AutoV3Toggle", false, function(IsEnabled)
    _G.ToggleStates[toggleKeyV3] = IsEnabled
    toggleAutoV3(IsEnabled)
end)

attackSection:Toggle("Auto Busoshoku Haki", "AutoHakiToggle", true, function(state)
    AutoHakiEnabled = state
    if state then
        startAutoHakiLoop()
        warn("[Auto Busoshoku Haki] Function enabled")
    else
        if autoHakiTask then
            task.cancel(autoHakiTask)
            autoHakiTask = nil
        end
        warn("[Auto Busoshoku Haki] Function disabled")
    end
end)
-- ===================== 快速攻击组件恢复逻辑 =====================
task.spawn(function()
    while true do
        task.wait(1)
        if not _ENV.rz_FastAttack and _G.FastAttack then
            warn("Fast Attack component not fully loaded, attempting recovery...")
            FastAttackModule = FastAttackModule or (function()
                local FastAttack = {
                    Distance=2500,
                    attackMobs=true,
                    attackPlayers=true,
                    Equipped=nil,
                    IsRunning=_G.FastAttack,
                    consecutiveFailures=0,
                    maxConsecutiveFailures=5
                }
                _ENV.rz_FastAttack = FastAttack
                return FastAttack
            end)()
        end
    end
end)

-- ===================== 透视标签页 =====================
local espSection = UITab4:section("ESP", true)

-- 透视配置
local ESPConfig = {
    MainSwitch = false,     
    ShowNameDistance = false, 
    ShowTracer = false,       
    ShowHealth = false        
}

local ESPElements = {}

-- 清理玩家ESP元素
local function CleanupPlayerESP(player)
    if not ESPElements[player.UserId] then return end
    
    if ESPElements[player.UserId].NameHealthESP then
        ESPElements[player.UserId].NameHealthESP:Destroy()
        ESPElements[player.UserId].NameHealthESP = nil
    end
    if ESPElements[player.UserId].NameHealthUpdateConn then
        ESPElements[player.UserId].NameHealthUpdateConn:Disconnect()
        ESPElements[player.UserId].NameHealthUpdateConn = nil
    end
    
    if ESPElements[player.UserId].Tracer then
        ESPElements[player.UserId].Tracer:Remove()
        ESPElements[player.UserId].Tracer = nil
    end
    if ESPElements[player.UserId].TracerConn then
        ESPElements[player.UserId].TracerConn:Disconnect()
        ESPElements[player.UserId].TracerConn = nil
    end
end

-- 创建名字/距离/血量ESP
local function CreateNameDistanceHealthESP(player)
    if not player.Character or not player.Character:FindFirstChild("Head") then return end
    local head = player.Character.Head
    
    if ESPElements[player.UserId] and ESPElements[player.UserId].NameHealthESP then
        ESPElements[player.UserId].NameHealthESP:Destroy()
    end
    
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "NameDistanceHealthESP"
    billboardGui.Adornee = head
    billboardGui.Size = UDim2.new(0, 120, 0, 50)
    billboardGui.StudsOffset = Vector3.new(0, 3.5, 0)
    billboardGui.AlwaysOnTop = true
    billboardGui.Parent = head
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Parent = billboardGui
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = player.Name
    nameLabel.Size = UDim2.new(1, 0, 0.33, 0)
    nameLabel.TextColor3 = Color3.new(1, 1, 1)
    nameLabel.TextScaled = true 
    nameLabel.Font = Enum.Font.GothamSemibold
    
    local healthLabel = Instance.new("TextLabel")
    healthLabel.Parent = billboardGui
    healthLabel.BackgroundTransparency = 1
    healthLabel.Position = UDim2.new(0, 0, 0.33, 0)
    healthLabel.Size = UDim2.new(1, 0, 0.33, 0)
    healthLabel.TextColor3 = Color3.new(0, 1, 0)
    healthLabel.TextScaled = true 
    healthLabel.Font = Enum.Font.Gotham
    
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Parent = billboardGui
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Position = UDim2.new(0, 0, 0.66, 0)
    distanceLabel.Size = UDim2.new(1, 0, 0.33, 0)
    distanceLabel.TextColor3 = Color3.new(1, 0.5, 0)
    distanceLabel.TextScaled = true
    distanceLabel.Font = Enum.Font.Gotham
    
    local updateConnection = RunService.RenderStepped:Connect(function()
        if not billboardGui.Parent or not LocalPlayer.Character or not player.Character then 
            return 
        end
        
        local localRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
        local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
        if localRoot and targetRoot then
            local distance = (localRoot.Position - targetRoot.Position).Magnitude
            distanceLabel.Text = string.format("%.1fm", distance)   
        end
        
        local humanoid = player.Character:FindFirstChild("Humanoid")
        if humanoid then
            local health = math.floor(humanoid.Health)
            local maxHealth = math.floor(humanoid.MaxHealth)
            
            local healthPercent = health / maxHealth
            if healthPercent > 0.7 then
                healthLabel.TextColor3 = Color3.new(0, 1, 0)
            elseif healthPercent > 0.3 then
                healthLabel.TextColor3 = Color3.new(1, 1, 0)
            else
                healthLabel.TextColor3 = Color3.new(1, 0, 0)
            end
            
            healthLabel.Text = string.format("HP: %d/%d", health, maxHealth)
        end
    end)
    
    ESPElements[player.UserId] = ESPElements[player.UserId] or {}
    ESPElements[player.UserId].NameHealthESP = billboardGui
    ESPElements[player.UserId].NameHealthUpdateConn = updateConnection
end

-- 创建射线ESP
local function CreateTracerESP(player)
    if ESPElements[player.UserId] and ESPElements[player.UserId].Tracer then
        ESPElements[player.UserId].Tracer:Remove()
    end
    
    local tracer = Drawing.new("Line")
    tracer.Color = Color3.new(1, 0, 0)
    tracer.Thickness = 2
    tracer.Transparency = 0.8
    tracer.Visible = false
    
    local renderConnection = RunService.RenderStepped:Connect(function()
        if not ESPConfig.MainSwitch or not ESPConfig.ShowTracer then
            tracer.Visible = false
            return
        end
        
        local localChar = LocalPlayer.Character
        local targetChar = player.Character
        if not localChar or not targetChar then
            tracer.Visible = false
            return
        end
        
        local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
        if targetRoot then
            local screenPos, isVisible = Camera:WorldToViewportPoint(targetRoot.Position)
            if isVisible then
                tracer.Visible = true
                tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
                tracer.To = Vector2.new(screenPos.X, screenPos.Y)
            else
                tracer.Visible = false
            end
        else
            tracer.Visible = false
        end
    end)
    
    ESPElements[player.UserId] = ESPElements[player.UserId] or {}
    ESPElements[player.UserId].Tracer = tracer
    ESPElements[player.UserId].TracerConn = renderConnection
end

-- 更新玩家ESP
local function UpdatePlayerESP(player)
    if player == LocalPlayer then return end
    
    if not player.Character or not player.Character:FindFirstChild("Head") or not player.Character:FindFirstChild("HumanoidRootPart") then
        CleanupPlayerESP(player)
        return
    end
    
    if ESPConfig.MainSwitch then
        CreateTracerESP(player)
        
        if ESPConfig.ShowNameDistance or ESPConfig.ShowHealth then
            CreateNameDistanceHealthESP(player)
        else
            CleanupPlayerESP(player)
        end
    else
        CleanupPlayerESP(player)
    end
end

-- 更新所有玩家ESP
local function UpdateAllESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            UpdatePlayerESP(player)
        end
    end
end

-- 处理玩家重生
local function HandlePlayerRespawn(player)
    local character = player.Character or player.CharacterAdded:Wait()
    
    local head = character:WaitForChild("Head", 5)
    local rootPart = character:WaitForChild("HumanoidRootPart", 5)
    local humanoid = character:WaitForChild("Humanoid", 5)
    
    if head and rootPart and humanoid then
        task.wait(0.5)
        UpdatePlayerESP(player)
    end
end

-- 玩家加入处理
Players.PlayerAdded:Connect(function(player)
    if player == LocalPlayer then return end
    
    if player.Character then
        task.spawn(HandlePlayerRespawn, player)
    end
    
    player.CharacterAdded:Connect(function()
        task.spawn(HandlePlayerRespawn, player)
    end)
    
    player.CharacterRemoving:Connect(function()
        CleanupPlayerESP(player)
    end)
end)

-- 本地玩家重生时更新所有ESP
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    UpdateAllESP()
end)

-- 定期更新ESP
task.spawn(function()
    while true do
        task.wait(3)
        if ESPConfig.MainSwitch then
            UpdateAllESP()
        end
    end
end)

-- 透视UI绑定
espSection:Toggle("ESP Main Switch", "ESP_Main", false, function(enabled)
    ESPConfig.MainSwitch = enabled
    UpdateAllESP()
end)

espSection:Toggle("Show Name + Distance", "ESP_NameDistance", false, function(enabled)
    ESPConfig.ShowNameDistance = enabled
    UpdateAllESP()
end)

espSection:Toggle("Show Health", "ESP_Health", false, function(enabled)
    ESPConfig.ShowHealth = enabled
    UpdateAllESP()
end)

espSection:Toggle("Tracer (Screen Center)", "ESP_Tracer", false, function(enabled)
    ESPConfig.ShowTracer = enabled
    UpdateAllESP()
end)

-- ===================== 传送标签页 =====================
local tpMainSection = UITab5:section("Teleport", false)

-- 海域传送
tpMainSection:Button("Teleport to First Sea", function()
    pcall(function()
        ReplicatedStorage.Remotes.CommF_:InvokeServer("TravelMain")
    end)
end)

tpMainSection:Button("Teleport to Second Sea", function()
    pcall(function()
        ReplicatedStorage.Remotes.CommF_:InvokeServer("TravelDressrosa")
    end)
end)

tpMainSection:Button("Teleport to Third Sea", function()
    pcall(function()
        ReplicatedStorage.Remotes.CommF_:InvokeServer("TravelZou")
    end)
end)

-- 二海传送点
local tp2Section = UITab5:section("Second Sea", false)
tp2Section:Button("Teleport to Swan's Room", function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(-287.37, 305.81, 592.98)
    end
end)

tp2Section:Button("Teleport to Mansion", function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(2286.93, 15.06, 910.51)
    end
end)

tp2Section:Button("Teleport Inside Ghost Ship", function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(-6501.06, 83.11, -123.52)
    end
end)

tp2Section:Button("Teleport Outside Ghost Ship", function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(922.78, 123.96, 32842.40)
    end
end)

-- 三海传送点
local tp3Section = UITab5:section("Third Sea", false)
tp3Section:Button("Teleport to Ocean Castle", function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(-12463.60, 376.26, -7566.08)
    end
end)

tp3Section:Button("Teleport to Turtle Mansion", function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(-5060.41, 316.43, -3192.30)
    end
end)

tp3Section:Button("Teleport to Justice", function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(-5096.48, 316.43, -3177.91)
    end
end)

tp3Section:Button("Teleport to Hydra", function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(-5027.03, 316.43, -3206.07)
    end
end)

-- ===================== 活动标签页（新增自动开佛拿刀） =====================
local activitySection = UITab6:section("Features", true)

-- 初始化全局设置（果实相关）
if not _G.Settings then
    _G.Settings = {
        Fruit = {
            ["Auto Buy Candy Fruit"] = false,
            ["Auto Store Fruit"] = false
        }
    }
end

-- 初始化保存设置函数
if not getgenv().SaveSetting then
    getgenv().SaveSetting = function()
    end
end

-- 果实名称映射表（完整列表）
local FruitMapping = {
    {"Rocket Fruit", "Rocket-Rocket"},
    {"Spin Fruit", "Spin-Spin"},
    {"Blade Fruit", "Blade-Blade"},
    {"Spring Fruit", "Spring-Spring"},
    {"Bomb Fruit", "Bomb-Bomb"},
    {"Smoke Fruit", "Smoke-Smoke"},
    {"Spike Fruit", "Spike-Spike"},
    {"Flame Fruit", "Flame-Flame"},
    {"Eagle Fruit", "Eagle-Eagle"},
    {"Ice Fruit", "Ice-Ice"},
    {"Sand Fruit", "Sand-Sand"},
    {"Dark Fruit", "Dark-Dark"},
    {"Diamond Fruit", "Diamond-Diamond"},
    {"Light Fruit", "Light-Light"},
    {"Rubber Fruit", "Rubber-Rubber"},
    {"Creation Fruit", "Creation-Creation"},
    {"Ghost Fruit", "Ghost-Ghost"},
    {"Magma Fruit", "Magma-Magma"},
    {"Quake Fruit", "Quake-Quake"},
    {"Buddha Fruit", "Buddha-Buddha"},
    {"Love Fruit", "Love-Love"},
    {"Spider Fruit", "Spider-Spider"},
    {"Sound Fruit", "Sound-Sound"},
    {"Phoenix Fruit", "Phoenix-Phoenix"},
    {"Portal Fruit", "Portal-Portal"},
    {"Lightning Fruit", "Lightning-Lightning"},
    {"Pain Fruit", "Pain-Pain"},
    {"Blizzard Fruit", "Blizzard-Blizzard"},
    {"Gravity Fruit", "Gravity-Gravity"},
    {"Mammoth Fruit", "Mammoth-Mammoth"},
    {"T-Rex Fruit", "T-Rex-T-Rex"},
    {"Dough Fruit", "Dough-Dough"},
    {"Shadow Fruit", "Shadow-Shadow"},
    {"Venom Fruit", "Venom-Venom"},
    {"Gas Fruit", "Gas-Gas"},
    {"Control Fruit", "Control-Control"},
    {"Spirit Fruit", "Spirit-Spirit"},
    {"Leopard Fruit", "Leopard-Leopard"},
    {"Yeti Fruit", "Yeti-Yeti"},
    {"Kitsune Fruit", "Kitsune-Kitsune"},
    {"Dragon Fruit", "Dragon-Dragon"}
}

-- 1. 自动用糖果抽果实功能
local AutoCandyFruitToggle = activitySection:Toggle("Auto Spin with Candy", "AutoCandyFruitToggle", _G.Settings.Fruit["Auto Buy Candy Fruit"] or false, function(state)
    _G.Settings.Fruit["Auto Buy Candy Fruit"] = state;
    getgenv().SaveSetting()
    if state then
        warn("[Auto Spin] Function enabled")
    else
        warn("[Auto Spin] Function disabled")
    end
end);

task.spawn(function()
    while true do
        task.wait(0.5)
        pcall(function()
            if _G.Settings.Fruit["Auto Buy Candy Fruit"] then
                local CommF_Remote = game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("CommF_", 5)
                if CommF_Remote and math.random(1, 5) == 1 then
                    local checkArgs = {"Cousin", "CheckCanBuyType", "F2PXmasWeek2Gacha25"}
                    CommF_Remote:InvokeServer(unpack(checkArgs))
                end

                if CommF_Remote then
                    local drawArgs = {"Cousin", "F2PXmasWeek2Gacha25"}
                    CommF_Remote:InvokeServer(unpack(drawArgs))
                end

                local GetIsComingSoon_Remote = game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("GetIsComingSoon", 5)
                if GetIsComingSoon_Remote and math.random(1, 10) == 1 then
                    GetIsComingSoon_Remote:InvokeServer()
                end
            end
        end)
    end
end);

-- 2. 修复版自动存储果实功能
local AutoStoreFruitToggle = activitySection:Toggle("Auto Store Fruits", "AutoStoreFruitToggle", _G.Settings.Fruit["Auto Store Fruit"] or false, function(state)
    _G.Settings.Fruit["Auto Store Fruit"] = state;
    getgenv().SaveSetting();
    getgenv().AutoStoreFruit = state
    if state then
        warn("[Auto Store Fruits] Function enabled")
    else
        warn("[Auto Store Fruits] Function disabled")
    end
end);

-- 自动存储核心循环（修复版）
task.spawn(function()
    while true do
        task.wait(0.2)
        if not getgenv().AutoStoreFruit then
            continue
        end

        local success, err = pcall(function()
            local LocalPlayer = game:GetService("Players").LocalPlayer
            if not LocalPlayer then return end

            local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
            if not Character then return end

            local Backpack = LocalPlayer:WaitForChild("Backpack", 5)
            if not Backpack then
                warn("[Auto Store] Backpack load timeout")
                return
            end

            local Remotes = game:GetService("ReplicatedStorage"):WaitForChild("Remotes", 5)
            local CommF_Remote = Remotes and Remotes:WaitForChild("CommF_", 5)
            if not CommF_Remote then
                warn("[Auto Store] CommF_ remote function not found")
                return
            end

            for _, fruitData in ipairs(FruitMapping) do
                local fruitName = fruitData[1]
                local fruitKey = fruitData[2]

                local fruitObj = Backpack:FindFirstChild(fruitName) or Character:FindFirstChild(fruitName)
                if fruitObj then
                    local callSuccess, callErr = pcall(function()
                        CommF_Remote:InvokeServer("StoreFruit", fruitKey, fruitObj)
                    end)

                    if callSuccess then
                        warn("[Auto Store] Successfully stored: ", fruitName)
                        task.wait(0.1)
                        if fruitObj.Parent then
                            fruitObj:Destroy()
                        end
                        break
                    else
                        warn("[Auto Store] Storage failed: ", fruitName, "Error: ", callErr)
                        local simpleArgs = {"StoreFruit", fruitKey:gsub("-", "")}
                        pcall(function()
                            CommF_Remote:InvokeServer(unpack(simpleArgs))
                            warn("[Auto Store] Successfully stored with simplified args: ", fruitName)
                        end)
                    end
                end
            end
        end)

        if not success then
            warn("[Auto Store] Execution error: ", err)
        end
    end
end)

-- ===================== 新增：自动开佛拿刀功能 =====================
-- 配置
local AUTO_BUDDHA_ENABLED = false
local CHECK_INTERVAL = 5
local BUDDHA_SLOT = 2
local SWORD_SLOT = 3
local BUDDHA_MIN_SIZE = 20.0
local SWORD_NAME = "Cursed Dual Katana"

-- 检测Buddha形态
local function isBuddhaForm()
    local character = LocalPlayer.Character
    if not character then return false end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return false end
    
    local sizeMagnitude = humanoidRootPart.Size.Magnitude
    return sizeMagnitude > BUDDHA_MIN_SIZE
end

-- 按下数字键切换栏位
local function pressNumberKey(number)
    local virtualInput = game:GetService("VirtualInputManager")
    local keyCode
    
    if number == 1 then keyCode = Enum.KeyCode.One
    elseif number == 2 then keyCode = Enum.KeyCode.Two
    elseif number == 3 then keyCode = Enum.KeyCode.Three
    elseif number == 4 then keyCode = Enum.KeyCode.Four
    elseif number == 5 then keyCode = Enum.KeyCode.Five
    elseif number == 6 then keyCode = Enum.KeyCode.Six
    elseif number == 7 then keyCode = Enum.KeyCode.Seven
    elseif number == 8 then keyCode = Enum.KeyCode.Eight
    else keyCode = Enum.KeyCode.Nine end
    
    virtualInput:SendKeyEvent(true, keyCode, false, nil)
    task.wait(0.05)
    virtualInput:SendKeyEvent(false, keyCode, false, nil)
end

-- 按下Z键
local function pressZKey()
    local virtualInput = game:GetService("VirtualInputManager")
    
    virtualInput:SendKeyEvent(true, Enum.KeyCode.Z, false, nil)
    task.wait(0.1)
    virtualInput:SendKeyEvent(false, Enum.KeyCode.Z, false, nil)
end

-- 检查是否持有刀
local function hasSwordEquipped()
    local character = LocalPlayer.Character
    if not character then return false end
    
    for _, child in ipairs(character:GetChildren()) do
        if child:IsA("Tool") and child.Name == SWORD_NAME then
            return true
        end
    end
    
    return false
end

-- 装备刀
local function equipSword()
    -- 先切换到刀的栏位
    pressNumberKey(SWORD_SLOT)
    task.wait(0.3)
    
    -- 检查是否已经装备
    if hasSwordEquipped() then
        return true
    end
    
    -- 尝试使用EquipEvent
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if backpack then
        local sword = backpack:FindFirstChild(SWORD_NAME)
        if sword then
            local equipEvent = sword:FindFirstChild("EquipEvent")
            if equipEvent and equipEvent:IsA("RemoteEvent") then
                pcall(function()
                    equipEvent:FireServer(true)
                end)
            end
        end
    end
    
    -- 检查是否装备成功
    task.wait(0.5)
    return hasSwordEquipped()
end

-- 变身Buddha
local function performBuddhaTransformation()
    local character = LocalPlayer.Character
    if not character then
        return false
    end
    
    -- 切换到Buddha工具
    pressNumberKey(BUDDHA_SLOT)
    task.wait(0.5)
    
    -- 按Z键变身
    pressZKey()
    
    -- 等待并检查变身结果
    local waitTime = 0
    local maxWaitTime = 3
    
    while waitTime < maxWaitTime do
        task.wait(0.1)
        waitTime = waitTime + 0.1
        
        if isBuddhaForm() then
            return true
        end
    end
    
    return false
end

-- 自动开佛拿刀主循环
local buddhaTask = nil
local function startBuddhaLoop()
    if buddhaTask then
        task.cancel(buddhaTask)
        buddhaTask = nil
    end
    
    buddhaTask = task.spawn(function()
        local lastCheckTime = 0
        
        while AUTO_BUDDHA_ENABLED do
            task.wait(1)
            
            local currentTime = tick()
            if currentTime - lastCheckTime >= CHECK_INTERVAL then
                lastCheckTime = currentTime
                
                if not LocalPlayer.Character then
                    -- 等待角色
                else
                    if isBuddhaForm() then
                        -- 检查并装备刀
                        if not hasSwordEquipped() then
                            equipSword()
                        end
                    else
                        -- 执行变身
                        local success = performBuddhaTransformation()
                        
                        if success then
                            -- 变身后装备刀
                            task.wait(0.5)
                            if not hasSwordEquipped() then
                                equipSword()
                            end
                        end
                    end
                end
            end
        end
        buddhaTask = nil
    end)
end


LocalPlayer.CharacterAdded:Connect(function()
    if AUTO_BUDDHA_ENABLED then
        task.wait(2)
        startBuddhaLoop()
    end
end)

-- 自动开佛拿刀开关
local autoBuddhaToggle = activitySection:Toggle("Auto Transform Buddha + Auto Equipment sword", "AutoBuddhaToggle", false, function(state)
    AUTO_BUDDHA_ENABLED = state
    if state then
        startBuddhaLoop()
        warn("[Auto Buddha + Sword] Function enabled")
    else
        if buddhaTask then
            task.cancel(buddhaTask)
            buddhaTask = nil
        end
        warn("[Auto Buddha + Sword] Function disabled")
    end
end)

activitySection:Button("Auto Dungeon", function()
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/ttker951-dot/y1/refs/heads/main/at%20fb"))()
    end)
end)


task.spawn(function()
    task.wait(2)
    UpdateAllESP()
end)

-- 加载完成提示
game:GetService("StarterGui"):SetCore("SendNotification",{
    Title = "人挤人",
    Text = "Loading complete. Enjoy using it!",
    Duration = 5;
})
